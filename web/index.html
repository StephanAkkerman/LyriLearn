<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LyriLearn – Minimal</title>
  <link rel="stylesheet" href="https://unpkg.com/mvp.css" />
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .muted{color:#666}
    .time{font-variant-numeric:tabular-nums}
    .line{padding:.15rem 0}
    /* Simple UPOS-based coloring */
    .upos-NOUN{background:#e6f4ff}
    .upos-VERB{background:#e8ffe6}
    .upos-ADJ{background:#fff6e6}
    .upos-ADV{background:#f3e6ff}
    .token{padding:0 .15rem;border-radius:.25rem}
  </style>
</head>
<body>
<main>
  <header>
    <h1>LyriLearn</h1>
    <p class="muted">Dual-pane lyrics ↔ translation (backend API required)</p>
  </header>

  <section>
    <form id="qform">
      <label>Title <input name="title" required placeholder="Dara" /></label>
      <label>Artist <input name="artist" required placeholder="Artist Name" /></label>
      <div class="grid">
        <label>Source (L2) <input name="src" value="id" /></label>
        <label>Target (L1) <input name="dest" value="en" /></label>
      </div>
      <label>Backend URL <input id="backend" placeholder="http://localhost:8000" /></label>
      <label><input type="checkbox" id="pos" checked /> Include POS</label>
      <button>Load</button>
    </form>
  </section>

  <section id="panes" hidden>
  <div id="pairs" class="pair-grid"></div>
</section>

</main>
<script>
const $ = sel => document.querySelector(sel);

const BACKEND_KEY = 'lyrilearn_backend_url';
$('#backend').value = localStorage.getItem(BACKEND_KEY) || 'http://localhost:8000';

const pairs = document.getElementById('pairs');

const fmt = s => s == null ? "" : String(s);
const fmtTime = t => t == null ? "" : new Date(Math.floor(t*1000)).toISOString().substr(14,5);

// Handle form submit -> fetch -> render
document.getElementById('qform').addEventListener('submit', async (e) => {
  e.preventDefault();

  const fd = new FormData(e.target);
  const title  = fd.get('title');
  const artist = fd.get('artist');
  const src    = fd.get('src');   // L2
  const dest   = fd.get('dest');  // L1
  const wantPOS = document.getElementById('pos').checked;

  const backend = $('#backend').value.replace(/\/$/, '');
  localStorage.setItem(BACKEND_KEY, backend);

  const url = `${backend}/api/lyrics-annotated?title=${encodeURIComponent(title)}&artist=${encodeURIComponent(artist)}&lang=${encodeURIComponent(src)}&dest=${encodeURIComponent(dest)}&pos=${wantPOS?1:0}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    renderPairs(data);
    document.getElementById('panes').hidden = false;
  } catch (err) {
    console.error('Fetch failed:', err);
    alert(`Request failed: ${err.message}`);
  }
});

function renderPairs(data) {
  pairs.innerHTML = '';
  for (const ln of data.lines) {
    // Left cell (L2)
    const left = document.createElement('div');
    left.className = 'cell';
    const tspan = `<span class="time">${fmtTime(ln.t)}</span> `;
    if (ln.tokens && ln.tokens.length) {
      const toks = ln.tokens.map(tok => {
        const cls = tok.upos ? `upos-${tok.upos}` : '';
        const title = `${tok.lemma||''} · ${tok.upos||''}${tok.feats?`\n${tok.feats}`:''}`;
        return `<span class="token ${cls}" title="${title}">${tok.text}</span>`;
      }).join(' ');
      left.innerHTML = `${tspan}${toks}`;
    } else {
      left.innerHTML = `${tspan}${fmt(ln.l2)}`;
    }

    // Right cell (L1)
    const right = document.createElement('div');
    right.className = 'cell';
    right.textContent = fmt(ln.l1);

    // Append in order -> same grid row
    pairs.appendChild(left);
    pairs.appendChild(right);
  }
}
</script>
</body>
</html>
